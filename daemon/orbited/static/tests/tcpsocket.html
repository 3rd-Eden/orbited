<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>TCPSocket unit tests</title>
        <script type="text/javascript" src="/static/dojo-trunk/dojo/dojo.js" djConfig="isDebug:true"></script>
        <script src="/static/Orbited.js"></script>
        <script type="text/javascript">
            dojo.require("doh.runner");

            TCPSocket = Orbited.TCPSocket;

            dojo.addOnLoad(function() {
                function setUpSocket(t) {
                    t._socket = new TCPSocket();
                }
                function tearDownSocket(t) {
                    try {
                        t._socket.onerror = function() {};
                        t._socket.onclose = function() {};
                        if (t._socket.readyState >= 2)
                            t._socket.close();
                    } catch (e) {
                        console.error("unable to close socket: ", e);
                    }
                }

                doh.register("TCPSocketTests",
                    [
                        {
                            name: "Baseline",
                            setUp: setUpSocket,
                            tearDown: tearDownSocket,
                            runTest: function(t) {
                                var endDeferred = new doh.Deferred();
                                var success = false;
                                var buffer = "";
                                var socket = t._socket;

                                socket.onopen = function() {
                                    socket.send("hello, world");
                                };
                                socket.onread = function(data) {
                                    buffer += data;
                                    if (buffer == "hello, world") {
                                        success = true;
                                        socket.close();
                                    }
                                };
                                socket.onclose = function() {
                                    if (success)
                                        endDeferred.callback(true);
                                    else
                                        endDeferred.errback(new Error("socket closed before receiving message"));
                                };
                                socket.onerror = function(error) {
                                    endDeferred.errback(error);
                                };

                                socket.open("localhost", 7);

                                return endDeferred;
                            }
                        },

                        {
                            name: "unauthorizedDestination",
                            setUp: setUpSocket,
                            tearDown: tearDownSocket,
                            runTest: function(t) {
                                var endDeferred = new doh.Deferred();
                                var onopenCalled = false;
                                var socket = t._socket;

                                socket.onopen = function() {
                                    onopenCalled = true;
                                    socket.close();
                                };
                                socket.onread = function(data) {
                                };
                                socket.onclose = function() {
                                    if (onopenCalled)
                                        endDeferred.errback(new Error("expected closed socket, but got open socket"));
                                    else
                                        endDeferred.callback(true);                                        
                                };
                                socket.onerror = function(error) {
                                    endDeferred.errback(error);
                                };

                                socket.open("localhost", 0);

                                return endDeferred;
                            }
                        },

                        {
                            name: "openCloseSocket",
                            setUp: setUpSocket,
                            tearDown: tearDownSocket,
                            runTest: function(t) {
                                var socket = t._socket;
                                // XXX this test seems to be leaving the socket running.
                            }
                        },
/*
                        {
                            name: "embeddedUnderlines",
                            setUp: setUpSocket,
                            tearDown: tearDownSocket,
                            runTest: function(t) {
                                var endDeferred = new doh.Deferred();
                                var success = false;
                                var buffer = "";
                                var socket = t._socket;
                                
                                var text = "01_2__3___4____5_____0";

                                socket.onopen = function() {
                                    socket.send(text);
                                };
                                socket.onread = function(data) {
                                    buffer += data;
                                    console.info("buffer contains: ", buffer);
                                    if (buffer == text) {
                                        success = true;
                                        socket.close();
                                    }
                                };
                                socket.onclose = function() {
                                    if (success)
                                        endDeferred.callback(true);
                                    else
                                        endDeferred.errback(new Error("socket closed before receiving message"));
                                };
                                socket.onerror = function(error) {
                                    endDeferred.errback(error);
                                };

                                socket.open("localhost", 7);

                                return endDeferred;
                            }
                        }
*/
                    ]
                );

                doh.run();
            })
        </script>
    </head>
    <body>
        <h1>NOTE</h1>
        <p>
            You need to enable the echo protocol in your system before
            openning this page AND edit orbited.cfg to enable
            connections to "localhost:7".
        </p>
        <p>For example, in debian/ubuntu you can do it like this:</p>
        <ol>
            <li>
                Install an inetd daemon, eg:
<pre>
    sudo apt-get install openbsd-inetd
</pre>
            </li>
            <li>
                Enable the echo protocol (should listen at TCP port 7)
                by adding the following line:
<pre>
    sudo vim /etc/inetd.conf
echo   stream  tcp     nowait  root    internal
</pre>
            </li>
            <li>
                Finally, restart inetd:
<pre>
    sudo invoke-rc.d openbsd-inetd restart
</pre>
            </li>
        </ol>
        <p>NB: if you running Firefox with Firebug, look at its console.</p>
    </body>
</html>
