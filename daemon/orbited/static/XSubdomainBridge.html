<html>
 <head>
  <script>
var origDomain = document.domain
var topDomain = null;
var id = parseInt(location.hash.slice(1));
    alert('xsubdomain bridge: ' + id)

//var id = location.hash
var parts = document.domain.split('.')
if (parts.length == 1) {
    try {
        document.domain = document.domain
        parent.XSubdomainRequest.prototype
        topDomain = document.domain
    }
    catch(e) {
    }
}
else {
    for (var i = 0; i < parts.length-1; ++i) {
        document.domain = parts.slice(i).join(".")
        try {
            parent.XSubdomainRequest.prototype
            topDomain = document.domain
            break;
        }
        catch(e) {
//            alert(e.name + ': ' + e.message)
        }
    }
}
if (topDomain == null)
    throw new Error("Invalid document.domain for cross-frame communication")

push(['initialized'])

try {
    document.domain = origDomain
}
catch(e) {
}
function getNext() {
    document.domain = topDomain
    var queue = parent.XSubdomainRequest.prototype._state.queues[id]
//    alert('queue: ' + parent.JSON.stringify(queue))
    var data = null
    if (queue.length > 0)
        data = queue.shift();
    try {
        document.domain = origDomain;
    }
    catch(e) {
    }
    return data
}
function push(data) {
    document.domain = topDomain
    parent.XSubdomainRequest.prototype._event(id, data);
    try {
        document.domain = origDomain;
    }
    catch(e) {
    }
}

function doNextRequest() {
    var req = getNext();
    if (req == null) {
        return setTimeout(doNextRequest, 10);
    }
    var smethod = req[0]
    var surl = req[1]
    var spayload = req[2];
    var sheaders = req[3];
    var markedResponseHeaders = req[4]
//    var h = []
//    for (key in sheaders)
//        h.push(key)
//    alert("url: " + surl + "\npayload: " + spayload + "\nheaders: " + h);


    var xhr = createXHR();
    var responseIndex = 0;
    xhr.onreadystatechange = function() {
        var payload = {
            readyState: xhr.readyState
        }
        if (xhr.readyState == 3) {
            try {
                var data = xhr.responseText.slice(responseIndex)
                responseIndex = xhr.responseText.length;
                payload['responseText'] = data;
            }
            catch(e) {
//                alert('status..?');
            }
        }
        if (xhr.readyState == 4) {
            payload['responseText'] = xhr.responseText.slice(responseIndex)
            payload['status'] = xhr.status
            var headers = {}
            for (var i = 0; i < markedResponseHeaders.length; ++i) {
                var h = markedResponseHeaders[i];
                var v = xhr.getResponseHeader(h)
                if (typeof(v) != "undefined" && v != null) {
                    headers[h] = v
                }
            }
            
            payload['headers'] = headers
            push(["readystatechange", payload])
            return doNextRequest();
        }
        push(["readystatechange", payload])
    }
//    alert('xhr.open(' + smethod + ', ' + surl + ', true)');
//    alert('document.domain: ' + document.domain);
    xhr.open(smethod, surl, true)
    for (key in sheaders) {
        xhr.setRequestHeader(key, sheaders[key])
    }
    xhr.send(spayload);
}

var createXHR = function() {
    try { return new ActiveXObject("Msxml2.XMLHTTP"); } catch (e) {}
    try { return new ActiveXObject("Microsoft.XMLHTTP"); } catch (e) {}
    try { return new XMLHttpRequest(); } catch(e) {}
    return null;
};

</script>
</head>
<body onload="doNextRequest()">
 <h1>Sub Domain</h1>
</body>
</html>