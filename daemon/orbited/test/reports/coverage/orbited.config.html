<html>
<head>
<title>orbited.config</title>
</head>
<body>
orbited.config
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 43 lines<br/>
Missed: 56 lines<br/>
Skipped 39 lines<br/>
Percent: 43 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>import os</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>import sys</pre></div>
<div class="skip"><span class="num"><pre>  3</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>map = {</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>    '[global]': {</pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>        'proxy.enabled': '1',</pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>        'session.ping_interval': '30',</pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>        'session.ping_timeout': '30'</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>    },</pre></div>
<div class="skip"><span class="num"><pre> 10</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 11</pre></span><pre>    '[logging]': {</pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>        'debug': 'SCREEN',</pre></div>
<div class="cov"><span class="num"><pre> 13</pre></span><pre>        'info': 'SCREEN',</pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>        'access': 'SCREEN',</pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>        'warn': 'SCREEN',</pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>        'error': 'SCREEN',</pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>        'enabled.default': 'info,access,warn,error',</pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>    },</pre></div>
<div class="skip"><span class="num"><pre> 19</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 20</pre></span><pre>    '[loggers]': {</pre></div>
<div class="skip"><span class="num"><pre> 21</pre></span><pre>        #'orbited.start': 'debug,info,access,warn,error',</pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>    },</pre></div>
<div class="skip"><span class="num"><pre> 23</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>    '[listen]': [</pre></div>
<div class="skip"><span class="num"><pre> 25</pre></span><pre>        #'http://:8001',</pre></div>
<div class="cov"><span class="num"><pre> 26</pre></span><pre>    ],</pre></div>
<div class="skip"><span class="num"><pre> 27</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>    '[test]': {</pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>        'stompdispatcher.enabled': '0',</pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>    },</pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>    '[ssl]': {</pre></div>
<div class="skip"><span class="num"><pre> 33</pre></span><pre>        #'key': 'orbited.key',</pre></div>
<div class="skip"><span class="num"><pre> 34</pre></span><pre>        #'crt': 'orbited.crt',</pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>    },</pre></div>
<div class="skip"><span class="num"><pre> 36</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>    '[access]': {</pre></div>
<div class="skip"><span class="num"><pre> 38</pre></span><pre>        #('irc.freenode.net', 6667): ['localhost:8001', '127.0.0.1:8001'],</pre></div>
<div class="cov"><span class="num"><pre> 39</pre></span><pre>    },</pre></div>
<div class="skip"><span class="num"><pre> 40</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>    '[static]': {</pre></div>
<div class="skip"><span class="num"><pre> 42</pre></span><pre>        #'tmp': '/tmp',</pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>    },</pre></div>
<div class="skip"><span class="num"><pre> 44</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>    'globalVars': {</pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>        'monitoring': False,</pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>        'connections': 0</pre></div>
<div class="cov"><span class="num"><pre> 48</pre></span><pre>    }</pre></div>
<div class="cov"><span class="num"><pre> 49</pre></span><pre>}</pre></div>
<div class="skip"><span class="num"><pre> 50</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 51</pre></span><pre>def config_error(msg):</pre></div>
<div class="nocov"><span class="num"><pre> 52</pre></span><pre>    print &quot;failed to load configuration file\n&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 53</pre></span><pre>    print msg</pre></div>
<div class="nocov"><span class="num"><pre> 54</pre></span><pre>    sys.exit(1)</pre></div>
<div class="skip"><span class="num"><pre> 55</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>def update(**kwargs):</pre></div>
<div class="nocov"><span class="num"><pre> 57</pre></span><pre>    map.update(kwargs)</pre></div>
<div class="nocov"><span class="num"><pre> 58</pre></span><pre>    return True</pre></div>
<div class="skip"><span class="num"><pre> 59</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 60</pre></span><pre>defaultPaths = [</pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>    'orbited.cfg',</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>    os.path.join('/', 'etc', 'orbited.cfg'),</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>    os.path.join('/', 'Program Files', 'Orbited', 'etc', 'orbited.cfg'),</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>]</pre></div>
<div class="skip"><span class="num"><pre> 65</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>def setup(paths=defaultPaths, options={}):</pre></div>
<div class="skip"><span class="num"><pre> 67</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 68</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 69</pre></span><pre>    if not hasattr(options, 'config') or not options.config:</pre></div>
<div class="skip"><span class="num"><pre> 70</pre></span><pre>        # no config file specified, try to search it.</pre></div>
<div class="nocov"><span class="num"><pre> 71</pre></span><pre>        for path in paths:</pre></div>
<div class="nocov"><span class="num"><pre> 72</pre></span><pre>            if os.path.exists(path):</pre></div>
<div class="nocov"><span class="num"><pre> 73</pre></span><pre>                options.config = path</pre></div>
<div class="nocov"><span class="num"><pre> 74</pre></span><pre>                break</pre></div>
<div class="skip"><span class="num"><pre> 75</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 76</pre></span><pre>    if not hasattr(options, 'config') or not options.config:</pre></div>
<div class="nocov"><span class="num"><pre> 77</pre></span><pre>        config_error('configuration file not found - please specify it in the --config command line argument')</pre></div>
<div class="skip"><span class="num"><pre> 78</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 79</pre></span><pre>    _load(open(options.config, 'r'))</pre></div>
<div class="skip"><span class="num"><pre> 80</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 81</pre></span><pre>def _load(f):</pre></div>
<div class="skip"><span class="num"><pre> 82</pre></span><pre>    # TODO why not use a python file as the configuration file?</pre></div>
<div class="nocov"><span class="num"><pre> 83</pre></span><pre>    lines = [line.strip() for line in f.readlines()]</pre></div>
<div class="nocov"><span class="num"><pre> 84</pre></span><pre>    map['default_config'] = 0    </pre></div>
<div class="nocov"><span class="num"><pre> 85</pre></span><pre>    section = None</pre></div>
<div class="nocov"><span class="num"><pre> 86</pre></span><pre>    try:</pre></div>
<div class="nocov"><span class="num"><pre> 87</pre></span><pre>        for (i, line) in enumerate(lines):</pre></div>
<div class="skip"><span class="num"><pre> 88</pre></span><pre>            # ignore comments and empty lines.</pre></div>
<div class="nocov"><span class="num"><pre> 89</pre></span><pre>            if '#' in line:</pre></div>
<div class="nocov"><span class="num"><pre> 90</pre></span><pre>                line, comment = line.split('#', 1)</pre></div>
<div class="nocov"><span class="num"><pre> 91</pre></span><pre>                line = line.strip()</pre></div>
<div class="nocov"><span class="num"><pre> 92</pre></span><pre>            if not line:</pre></div>
<div class="nocov"><span class="num"><pre> 93</pre></span><pre>                continue</pre></div>
<div class="skip"><span class="num"><pre> 94</pre></span><pre>            </pre></div>
<div class="skip"><span class="num"><pre> 95</pre></span><pre>            # start of new section; create a dictionary for it in map if one</pre></div>
<div class="skip"><span class="num"><pre> 96</pre></span><pre>            # doesn't already exist</pre></div>
<div class="nocov"><span class="num"><pre> 97</pre></span><pre>            if line.startswith('[') and line.endswith(']'):</pre></div>
<div class="nocov"><span class="num"><pre> 98</pre></span><pre>                section = line</pre></div>
<div class="nocov"><span class="num"><pre> 99</pre></span><pre>                if section not in map:</pre></div>
<div class="nocov"><span class="num"><pre>100</pre></span><pre>                    map[section]  = {}</pre></div>
<div class="nocov"><span class="num"><pre>101</pre></span><pre>                continue</pre></div>
<div class="skip"><span class="num"><pre>102</pre></span><pre>            </pre></div>
<div class="skip"><span class="num"><pre>103</pre></span><pre>            # assign each source in the access section to a target address and port</pre></div>
<div class="nocov"><span class="num"><pre>104</pre></span><pre>            if section == '[access]':</pre></div>
<div class="nocov"><span class="num"><pre>105</pre></span><pre>                if '-&gt;' not in line:</pre></div>
<div class="nocov"><span class="num"><pre>106</pre></span><pre>                    raise Exception, 'line %s: &quot;%s&quot;\n[access] lines must contain an &quot;-&gt;&quot;'% ((i+1), line)</pre></div>
<div class="nocov"><span class="num"><pre>107</pre></span><pre>                source, dest = line.split('-&gt;')</pre></div>
<div class="nocov"><span class="num"><pre>108</pre></span><pre>                source, dest = source.strip(), dest.strip()</pre></div>
<div class="nocov"><span class="num"><pre>109</pre></span><pre>                if dest == &quot;*&quot;:</pre></div>
<div class="nocov"><span class="num"><pre>110</pre></span><pre>                    raise Exception, 'line %s: &quot;%s&quot;\nillegal [access] entry: wildcard destination' % ((i+1), line)</pre></div>
<div class="nocov"><span class="num"><pre>111</pre></span><pre>                if ':' in dest:</pre></div>
<div class="nocov"><span class="num"><pre>112</pre></span><pre>                    daddr, dport = dest.split(':', 1)</pre></div>
<div class="nocov"><span class="num"><pre>113</pre></span><pre>                    dport = int(dport)</pre></div>
<div class="nocov"><span class="num"><pre>114</pre></span><pre>                else:</pre></div>
<div class="nocov"><span class="num"><pre>115</pre></span><pre>                    daddr, dport = dest, 80</pre></div>
<div class="nocov"><span class="num"><pre>116</pre></span><pre>                if (daddr, dport) not in map[section]:</pre></div>
<div class="nocov"><span class="num"><pre>117</pre></span><pre>                    map[section][(daddr, dport)] = []</pre></div>
<div class="nocov"><span class="num"><pre>118</pre></span><pre>                map[section][(daddr, dport)].append(source)</pre></div>
<div class="nocov"><span class="num"><pre>119</pre></span><pre>                continue</pre></div>
<div class="nocov"><span class="num"><pre>120</pre></span><pre>            if section == '[listen]':</pre></div>
<div class="nocov"><span class="num"><pre>121</pre></span><pre>                map[section].append(line)</pre></div>
<div class="nocov"><span class="num"><pre>122</pre></span><pre>                continue</pre></div>
<div class="skip"><span class="num"><pre>123</pre></span><pre>            </pre></div>
<div class="skip"><span class="num"><pre>124</pre></span><pre>            # skip lines which do not assign a value to a key</pre></div>
<div class="nocov"><span class="num"><pre>125</pre></span><pre>            if '=' not in line:</pre></div>
<div class="nocov"><span class="num"><pre>126</pre></span><pre>                raise Exception('parse error on line %d' % i)</pre></div>
<div class="skip"><span class="num"><pre>127</pre></span><pre>            </pre></div>
<div class="nocov"><span class="num"><pre>128</pre></span><pre>            key, value = [side.strip() for side in line.split('=', 1)]</pre></div>
<div class="skip"><span class="num"><pre>129</pre></span><pre>            </pre></div>
<div class="skip"><span class="num"><pre>130</pre></span><pre>            # in log section, value should be a tuple of one or two values</pre></div>
<div class="nocov"><span class="num"><pre>131</pre></span><pre>            if section == '[log]':</pre></div>
<div class="nocov"><span class="num"><pre>132</pre></span><pre>                value = tuple([val.strip() for val in value.split(',', 1)])</pre></div>
<div class="skip"><span class="num"><pre>133</pre></span><pre>            </pre></div>
<div class="nocov"><span class="num"><pre>134</pre></span><pre>            map[section][key] = value</pre></div>
<div class="nocov"><span class="num"><pre>135</pre></span><pre>    except Exception, e:</pre></div>
<div class="nocov"><span class="num"><pre>136</pre></span><pre>        config_error(e)</pre></div>
<div class="nocov"><span class="num"><pre>137</pre></span><pre>    return True</pre></div>
<div class="skip"><span class="num"><pre>138</pre></span><pre></pre></div>
</div>
</body>
</html>
